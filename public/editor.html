<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="Elements/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editor | Schedify</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div id="navbar-container"></div>
  <div id="login-modal-container"></div>
  <div id="roomTopicAssignmentContainer"></div>
  <section id="scheduleDisplaySection" style="margin-top: 2em;">
    <h2>Generated Schedule</h2>
    <table id="scheduleTable" border="1" style="border-collapse: collapse; width: 100%;"></table>
    <button id="clearScheduleBtn" style="margin-top: 1em; padding: 8px 12px;">Clear Schedule</button>
  </section>

  <script src="eventListener.js"></script>
  <script>
    function transformSchedule(flatSchedule) {
      const periodsSet = new Set(flatSchedule.map(s => s.period));
      const periods = Array.from(periodsSet).sort((a, b) => a - b);
      const roomsSet = new Set(flatSchedule.map(s => s.room));
      const rooms = Array.from(roomsSet).sort();
      const nestedSchedule = periods.map(() => Array(rooms.length).fill(null));
      flatSchedule.forEach(slot => {
        const periodIndex = periods.indexOf(slot.period);
        const roomIndex = rooms.indexOf(slot.room);
        if (periodIndex >= 0 && roomIndex >= 0) {
          nestedSchedule[periodIndex][roomIndex] = {
            student: slot.name,
            topic: slot.topic,
            project: slot.projectName || "",
            date: slot.date
          };
        }
      });
      return { nestedSchedule, periods, rooms };
    }

    const flatSchedule = JSON.parse(localStorage.getItem("scheduleData") || "[]");
    const topicColors = JSON.parse(localStorage.getItem("topicColors") || "{}");
    const { nestedSchedule: schedule, periods } = transformSchedule(flatSchedule);
    const scheduleTable = document.getElementById("scheduleTable");

    if (schedule.length === 0 || periods.length === 0) {
      scheduleTable.innerHTML = "<tr><td>No schedule data found.</td></tr>";
    } else {
      displaySchedule(schedule, periods, topicColors);
      renderColorKey(topicColors);
    }

    function displaySchedule(schedule, periods, topicColors) {
      let tableHTML = "<tr><th>Period</th>";
      for (let i = 0; i < schedule[0].length; i++) {
        tableHTML += `<th>Room ${i + 1}</th>`;
      }
      tableHTML += "</tr>";
      for (let periodIndex = 0; periodIndex < periods.length; periodIndex++) {
        const periodLabel = periods[periodIndex] || `Period ${periodIndex + 1}`;
        const row = schedule[periodIndex] || [];
        tableHTML += `<tr><td>${periodLabel}</td>`;
        for (let roomIndex = 0; roomIndex < row.length; roomIndex++) {
          const slot = row[roomIndex];
          const studentName = slot?.student || "";
          const topic = slot?.topic || "";
          const project = slot?.project || "";
          const color = topicColors[topic] || "#fff";
          tableHTML += `<td class="schedule-slot" style="background-color: ${color}; padding: 5px;">`;
          if (studentName) {
            tableHTML += `
              <div class="student-entry" draggable="true">
                <strong>${studentName}</strong><br>
                <small>${project}</small>
              </div>`;
          }
          tableHTML += "</td>";
        }
        tableHTML += "</tr>";
      }
      scheduleTable.innerHTML = tableHTML;
      setupDragAndDrop();
    }

    function setupDragAndDrop() {
      let draggedEl = null;
      function addDragAndDropEvents(el) {
        el.addEventListener("dragstart", (e) => {
          draggedEl = el;
          el.classList.add("dragging");
          setTimeout(() => el.style.display = "none", 0);
        });
        el.addEventListener("dragend", () => {
          if (draggedEl) {
            draggedEl.classList.remove("dragging");
            draggedEl.style.display = "";
            draggedEl = null;
          }
        });
      }
      const studentEntries = scheduleTable.querySelectorAll(".student-entry");
      studentEntries.forEach(addDragAndDropEvents);
      scheduleTable.addEventListener("dragover", e => {
        e.preventDefault();
      });
      scheduleTable.addEventListener("drop", e => {
        e.preventDefault();
        const dropTarget = e.target.closest("td.schedule-slot");
        if (dropTarget && draggedEl) {
          draggedEl.style.display = "";
          dropTarget.appendChild(draggedEl);
        }
      });
    }

    function renderColorKey(topicColors) {
      const keyContainer = document.createElement("div");
      keyContainer.id = "colorKey";
      keyContainer.style.marginTop = "1em";
      keyContainer.style.display = "flex";
      keyContainer.style.flexWrap = "wrap";
      keyContainer.style.gap = "10px";
      keyContainer.innerHTML = "<strong>Project Topic Colors:</strong><br/>";
      for (const [topic, color] of Object.entries(topicColors)) {
        const entry = document.createElement("div");
        entry.style.backgroundColor = color;
        entry.style.padding = "5px 10px";
        entry.style.border = "1px solid #aaa";
        entry.style.borderRadius = "4px";
        entry.style.fontSize = "0.9em";
        entry.style.whiteSpace = "nowrap";
        entry.textContent = topic || "No Topic";
        keyContainer.appendChild(entry);
      }
      document.body.appendChild(keyContainer);
    }

    document.getElementById("clearScheduleBtn").addEventListener("click", () => {
      scheduleTable.innerHTML = "";
      localStorage.removeItem("scheduleData");
      localStorage.removeItem("periods");
      localStorage.removeItem("topicColors");
      document.getElementById("colorKey")?.remove();
    });

    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar-container').innerHTML = data;
      })
      .catch(error => console.error('Error loading navbar:', error));

    fetch('loginModal.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('login-modal-container').innerHTML = data;
        const script = document.createElement('script');
        script.src = 'eventListener.js';
        script.onload = () => initLoginLogic();
        document.body.appendChild(script);
      })
      .catch(error => console.error('Error loading login modal:', error));
  </script>
</body>
</html>
